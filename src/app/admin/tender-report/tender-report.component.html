<div class="tender-page-card">
  <div class="page-header">
    <h1 class="pageName">گزارش مناقصه</h1>
    <button nz-button nzType="primary" nzShape="round" nzSize="large" (click)="loadReport()" [disabled]="filterForm.invalid || loadingReport">
      به‌روزرسانی گزارش
    </button>
  </div>

  <div class="filter-card">
    <form nz-form [formGroup]="filterForm" (ngSubmit)="loadReport()" class="filter-form">
      <nz-form-item>
        <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired>مناقصه</nz-form-label>
        <nz-form-control [nzSm]="18" [nzXs]="24">
          <nz-select
            formControlName="TenderId"
            nzPlaceHolder="انتخاب مناقصه..."
            [nzLoading]="loadingTenders"
            nzShowSearch
            nzAllowClear
          >
            <nz-option
              *ngFor="let tender of tenders"
              [nzValue]="tender.Id"
              [nzLabel]="tender.Title + ' (کد ' + tender.Id + ')' "
            ></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>
      <button nz-button nzType="primary" nzShape="round" [disabled]="filterForm.invalid || loadingReport">مشاهده گزارش</button>
    </form>
  </div>

  <nz-card class="summary-card" *ngIf="report">
    <nz-card-meta
      nzTitle="خلاصه گزارش"
      [nzDescription]="'تعداد شرکت‌کننده‌ها: ' + (report?.UsersCount ?? 0) + ' | کمترین پیشنهاد: ' + ((report?.MinPriceOffer ?? 0) | number)"
    ></nz-card-meta>
    <div class="winner" *ngIf="report?.Winner; else noWinner">
      <strong>برنده:</strong>
      {{ report?.Winner?.Username || ('پیمانکار شماره ' + report?.Winner?.UserId) }}
      — {{ report?.Winner?.PriceOffer | number }}
    </div>
    <ng-template #noWinner>
      <div class="winner">
        <strong>برنده:</strong> هنوز برنده‌ای تعیین نشده است.
      </div>
    </ng-template>
  </nz-card>

  <nz-skeleton *ngIf="loadingReport" [nzActive]="true"></nz-skeleton>
  <nz-empty
    *ngIf="!loadingReport && !report"
    nzNotFoundContent="برای مشاهده اطلاعات، مناقصه را انتخاب و گزارش را مشاهده کنید."
  ></nz-empty>

  <div class="grid-card" *ngIf="report">
    <div class="grid-wrapper">
      <ag-grid-angular
        class="ag-theme-quartz tender-grid"
        [theme]="'legacy'"
        [enableRtl]="true"
        [columnDefs]="columnDefs"
        [defaultColDef]="defaultColumnDefs"
        [rowData]="participantsRowData"
        (gridReady)="onGridReady($event)"
      ></ag-grid-angular>
    </div>
  </div>
</div>
